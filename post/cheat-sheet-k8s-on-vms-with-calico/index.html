<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="generator" content="Source Themes Academic 2.4.0">
  <meta name="generator" content="Hugo 0.49" />
  <meta name="author" content="Noel">

  
  
  
  
    
  
  <meta name="description" content="This is the cheat sheet for the post : https://netmemo.github.io/post/k8s-on-vms-with-calico/
The following post contain raw entry only for reminder purpose.
Bellow are the links I&rsquo;ve used to understand/did my lab
https://fr.wikipedia.org/wiki/Kubernetes#/media/File:Kubernetes.png https://kubernetes.io/docs/setup/independent/install-kubeadm/ https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/ https://kubernetes.io/docs/tutorials/k8s101/ https://kubernetes.io/docs/tutorials/k8s201/ https://kubernetes.io/docs/reference/kubectl/cheatsheet/
Join a node/worker to the master
kubeadm join 10.0.1.10:6443 --token d34b9i.v03t2yiozio63cq6 --discovery-token-ca-cert-hash sha256:c21d04ea23790a0bf81cf64118e3a9075ffb63ed90bc697acef5793386e9eb16  Delete a deployment
kubectl delete deployment nginx-deployment-nbo  To get the logs of a specific container. -n is to specify the namespace">

  
  <link rel="alternate" hreflang="en-us" href="https://netmemo.github.io/post/cheat-sheet-k8s-on-vms-with-calico/">

  


  

  

  

  
  
  
  <meta name="theme-color" content="hsl(#98F5FF, 90%, 68%)">
  

  
  
  
  
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha256-eSi1q2PG6J7g7ib17yAaWMcrr5GrtohYChqibrV7PBE=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css" integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.css" integrity="sha256-ygkqlh3CYSUri3LhQxzdcm0n1EQvH2Y+U5S2idbLtxs=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css" crossorigin="anonymous">
        
      
    

    

    

  

  
  
  <link rel="stylesheet" href=//fonts.googleapis.com/css?family=Montserrat:400,700|Roboto:400,400italic,700|Roboto+Mono>
  

  <link rel="stylesheet" href="/styles.css">
  

  
  
  

  
  <link rel="alternate" href="https://netmemo.github.io/index.xml" type="application/rss+xml" title="netmemo.github.io">
  <link rel="feed" href="https://netmemo.github.io/index.xml" type="application/rss+xml" title="netmemo.github.io">
  

  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/icon-192.png">

  <link rel="canonical" href="https://netmemo.github.io/post/cheat-sheet-k8s-on-vms-with-calico/">

  <meta property="twitter:card" content="summary_large_image">
  
  <meta property="og:site_name" content="netmemo.github.io">
  <meta property="og:url" content="https://netmemo.github.io/post/cheat-sheet-k8s-on-vms-with-calico/">
  <meta property="og:title" content="[Cheat Sheet] K8s on VMs with Calico | netmemo.github.io">
  <meta property="og:description" content="This is the cheat sheet for the post : https://netmemo.github.io/post/k8s-on-vms-with-calico/
The following post contain raw entry only for reminder purpose.
Bellow are the links I&rsquo;ve used to understand/did my lab
https://fr.wikipedia.org/wiki/Kubernetes#/media/File:Kubernetes.png https://kubernetes.io/docs/setup/independent/install-kubeadm/ https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/ https://kubernetes.io/docs/tutorials/k8s101/ https://kubernetes.io/docs/tutorials/k8s201/ https://kubernetes.io/docs/reference/kubectl/cheatsheet/
Join a node/worker to the master
kubeadm join 10.0.1.10:6443 --token d34b9i.v03t2yiozio63cq6 --discovery-token-ca-cert-hash sha256:c21d04ea23790a0bf81cf64118e3a9075ffb63ed90bc697acef5793386e9eb16  Delete a deployment
kubectl delete deployment nginx-deployment-nbo  To get the logs of a specific container. -n is to specify the namespace">
  
  
    
  <meta property="og:image" content="https://netmemo.github.io/img/icon-192.png">
  <meta property="og:locale" content="en-us">
  
  <meta property="article:published_time" content="2018-10-04T00:37:20&#43;02:00">
  
  <meta property="article:modified_time" content="2018-10-04T00:37:20&#43;02:00">
  

  

  

  <title>[Cheat Sheet] K8s on VMs with Calico | netmemo.github.io</title>

</head>
<body id="top" data-spy="scroll" data-target="#TableOfContents" data-offset="71" class="dark">

<nav class="navbar navbar-light fixed-top navbar-expand-lg py-0" id="navbar-main">
  <div class="container">

    
      <a class="navbar-brand" href="/">netmemo.github.io</a>
      
      <button type="button" class="navbar-toggler" data-toggle="collapse"
              data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
        <span><i class="fas fa-bars"></i></span>
      </button>
      

    
    <div class="collapse navbar-collapse" id="navbar">

      
      
      <ul class="navbar-nav ml-auto">
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#hero">
            
            <span>Home</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#posts">
            
            <span>Posts</span>
            
          </a>
        </li>

        
        

        

        
        
        
          
        

        <li class="nav-item">
          <a class="nav-link" href="/#about">
            
            <span>About</span>
            
          </a>
        </li>

        
        

      

        

        
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  





  <div class="article-container">
    <h1 itemprop="name">[Cheat Sheet] K8s on VMs with Calico</h1>

    

<div class="article-metadata">

  
  
  
  <div>
    
    <span itemscope itemprop="author" itemtype="http://schema.org/Person">
      <span itemprop="name">Noel</span>
    </span>
    
  </div>
  

  <span class="article-date">
    
    <meta content="2018-10-04 00:37:20 &#43;0200 CEST" itemprop="datePublished">
    <time datetime="2018-10-04 00:37:20 &#43;0200 CEST" itemprop="dateModified">
      Oct 4, 2018
    </time>
  </span>
  <span itemscope itemprop="publisher" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Noel">
  </span>

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    4 min read
  </span>
  

  
  

  
  
  
  <span class="middot-divider"></span>
  <span class="article-categories">
    <i class="fas fa-folder"></i>
    
    <a href="/categories/container/">container</a>
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=%5bCheat%20Sheet%5d%20K8s%20on%20VMs%20with%20Calico&amp;url=https%3a%2f%2fnetmemo.github.io%2fpost%2fcheat-sheet-k8s-on-vms-with-calico%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fnetmemo.github.io%2fpost%2fcheat-sheet-k8s-on-vms-with-calico%2f"
         target="_blank" rel="noopener">
        <i class="fab fa-facebook-f"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fnetmemo.github.io%2fpost%2fcheat-sheet-k8s-on-vms-with-calico%2f&amp;title=%5bCheat%20Sheet%5d%20K8s%20on%20VMs%20with%20Calico"
         target="_blank" rel="noopener">
        <i class="fab fa-linkedin-in"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=https%3a%2f%2fnetmemo.github.io%2fpost%2fcheat-sheet-k8s-on-vms-with-calico%2f&amp;title=%5bCheat%20Sheet%5d%20K8s%20on%20VMs%20with%20Calico"
         target="_blank" rel="noopener">
        <i class="fab fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=%5bCheat%20Sheet%5d%20K8s%20on%20VMs%20with%20Calico&amp;body=https%3a%2f%2fnetmemo.github.io%2fpost%2fcheat-sheet-k8s-on-vms-with-calico%2f">
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>


    <div class="article-style" itemprop="articleBody">
      <p>This is the cheat sheet for the post : <a href="https://netmemo.github.io/post/k8s-on-vms-with-calico/" target="_blank">https://netmemo.github.io/post/k8s-on-vms-with-calico/</a></p>

<p>The following post contain raw entry only for reminder purpose.</p>

<p>Bellow are the links I&rsquo;ve used to understand/did my lab</p>

<p><a href="https://fr.wikipedia.org/wiki/Kubernetes#/media/File:Kubernetes.png" target="_blank">https://fr.wikipedia.org/wiki/Kubernetes#/media/File:Kubernetes.png</a>
<a href="https://kubernetes.io/docs/setup/independent/install-kubeadm/" target="_blank">https://kubernetes.io/docs/setup/independent/install-kubeadm/</a>
<a href="https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/" target="_blank">https://kubernetes.io/docs/setup/independent/create-cluster-kubeadm/</a>
<a href="https://kubernetes.io/docs/tutorials/k8s101/" target="_blank">https://kubernetes.io/docs/tutorials/k8s101/</a>
<a href="https://kubernetes.io/docs/tutorials/k8s201/" target="_blank">https://kubernetes.io/docs/tutorials/k8s201/</a>
<a href="https://kubernetes.io/docs/reference/kubectl/cheatsheet/" target="_blank">https://kubernetes.io/docs/reference/kubectl/cheatsheet/</a></p>

<p>Join a node/worker to the master</p>

<pre><code>kubeadm join 10.0.1.10:6443 --token d34b9i.v03t2yiozio63cq6 --discovery-token-ca-cert-hash sha256:c21d04ea23790a0bf81cf64118e3a9075ffb63ed90bc697acef5793386e9eb16
</code></pre>

<p>Delete a deployment</p>

<pre><code>kubectl delete deployment nginx-deployment-nbo
</code></pre>

<p>To get the logs of a specific container. -n is to specify the namespace</p>

<pre><code>kubectl logs calico-node-zxvjv -n kube-system calico-node
</code></pre>

<p>Allow to launch a shell for a specific container</p>

<pre><code>kubectl exec -it nginx-deployment-nbo-fd57b7b88-l8xsv -- /bin/bash
</code></pre>

<p>Create a static page in the container to differentiate it from the others.
The -c option is to ask bash to execute the command.</p>

<pre><code>kubectl exec -it nginx-deployment-nbo-fd57b7b88-kkw9s -- /bin/bash -c &quot;echo Hello shell demo SRV1 &gt; /usr/share/nginx/html/index.html&quot; 
kubectl exec -it nginx-deployment-nbo-fd57b7b88-kkw9s cat /usr/share/nginx/html/index.html
</code></pre>

<p>To troubleshhot</p>

<pre><code>journalctl -r
</code></pre>

<p>Display all pods, even with the system name space, -o wide allow to see the IP addresses</p>

<pre><code>kubectl get pods --all-namespaces -o wide
</code></pre>

<p>To see the last messages of container associated to the pode</p>

<pre><code>kubectl describe pod -n kube-system calico-node-zxvjv
</code></pre>

<p>Allow to see the node/server/worker ip addresses (-o wide)</p>

<pre><code>sudo kubectl get node -o wide
</code></pre>

<p>by default kubernetes don&rsquo;t work with swap, so I needed to disable it with the command swapoff and to comment the swap line in the fstab file.</p>

<pre><code>swapoff

vi /etc/fstab

# /etc/fstab: static file system information.
#
# Use 'blkid' to print the universally unique identifier for a
# device; this may be used with UUID= as a more robust way to name devices
# that works even if disks are added and removed. See fstab(5).
#
# /dev/mapper/ubuntu--srv--base--vg-root / ext4 errors=remount-ro 0 1
#/dev/mapper/ubuntu--srv--base--vg-swap_1 none swap sw 0 0
</code></pre>

<p>Not related to Kubernets but you need to modify the interfaces</p>

<pre><code>vi /etc/netplan/01-netcfg.yaml
</code></pre>

<p>Add interfaces to ubuntu</p>

<pre><code>/etc/netplan/01-netcfg.yaml
</code></pre>

<p>This file describes the network interfaces available on your system
For more information, see netplan(5).</p>

<pre><code>network:
  version: 2
  renderer: networkd
  ethernets:
    enp0s3:
      dhcp4: no
      addresses:
         - 10.0.1.10/24
      routes:
         - to: 0.0.0.0/0
           via: 10.0.1.253
      nameservers:
         addresses: [1.1.1.1]
</code></pre>

<p>apply the /etc/netplan/01-netcfg.yaml configuration</p>

<pre><code>netplan apply
</code></pre>

<p>display ip addresses on interfaces</p>

<pre><code>ip address show
</code></pre>

<p>display all interfaces</p>

<pre><code>ip link show
</code></pre>

<p>display routes</p>

<pre><code>route -n
</code></pre>

<p>In order for Kubernetes to work, you need container runtime to be started</p>

<pre><code>systemctl enable docker.service
systemctl start docker.service
</code></pre>

<p>Download calicoctl, to be able to interact with calico with CLI</p>

<pre><code>sudo curl -O -L https://github.com/projectcalico/calicoctl/releases/download/v3.2.1/calicoctl
sudo chmod +x calicoctl
</code></pre>

<p>To see the state of calico on nodes (BGP,Peer-type,up/down,time)</p>

<pre><code>sudo calicoctl node status
</code></pre>

<p>The following commands allow to export a variables with the IP address and ports of nginx-service previously created and access the content from the host or the container</p>

<pre><code>export SERVICE_IP=$(kubectl get service nginx-service -o go-template='{{.spec.clusterIP}}')
export SERVICE_PORT=$(kubectl get service nginx-service -o go-template='{{(index .spec.ports 0).port}}')
wget -qO- http://$SERVICE_IP:$SERVICE_PORT
kubectl run busybox --generator=run-pod/v1 --image=busybox --restart=Never --tty -i --env &quot;SERVICE_IP=$SERVICE_IP&quot; --env &quot;SERVICE_PORT=$SERVICE_PORT&quot;

u@busybox$ wget -qO- http://$SERVICE_IP:$SERVICE_PORT # Run in the busybox container
u@busybox$ exit # Exit the busybox container
</code></pre>

<pre><code>noel@ubuntu-srv-1:~$ cat nginx-test.yaml

apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
kind: Deployment
metadata:
  name: nginx-deployment-nbo
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 3 # tells deployment to run 3 pods matching the template
  template:
    metadata:
      labels:
        app: nginx
    spec:
      volumes:
      - name: shared-data
        emptyDir: {}
      containers:
      - name: nginx
        image: nginx:1.7.9
        volumeMounts:
        - name: shared-data
          mountPath: /usr/share/nginx/html
        ports:
        - containerPort: 80
</code></pre>

<p><a href="https://kubernetes.io/docs/tutorials/k8s201/" target="_blank">https://kubernetes.io/docs/tutorials/k8s201/</a></p>

<pre><code>apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  ports:
  - port: 8000 # the port that this service should serve on
    # the container on each pod to connect to, can be a name
    # (e.g. 'www') or a number (e.g. 80)
    targetPort: 80
    protocol: TCP
  # just like the selector in the deployment,
  # but this time it identifies the set of pods to load balance
  # traffic to.
  selector:
    app: nginx
</code></pre>

<p>These commands are to configure calicoctl in order to work with the local k8s</p>

<pre><code>export CALICO_DATASTORE_TYPE=kubernetes
export CALICO_KUBECONFIG=~/.kube/config
Pour le root
export CALICO_KUBECONFIG=/home/noel/.kube/config
</code></pre>

<p>Move the Calico mode from Always to CrossSubnet.
First we get the calico ippool configuration, then we need to modify the ipipMode in the yaml file and eventually to apply the new configuration</p>

<pre><code>calicoctl get ippool -o yaml &gt; ippool.yaml 
</code></pre>

<p>Change the mode
    ipipMode: CrossSubnet</p>

<pre><code>calicoctl apply -f ippool.yaml
</code></pre>

    </div>

    


<div class="article-tags">
  
  <a class="badge badge-light" href="/tags/calico/">calico</a>
  
  <a class="badge badge-light" href="/tags/docker/">docker</a>
  
  <a class="badge badge-light" href="/tags/k8s/">k8s</a>
  
  <a class="badge badge-light" href="/tags/kubernetes/">kubernetes</a>
  
  <a class="badge badge-light" href="/tags/netplan/">netplan</a>
  
  <a class="badge badge-light" href="/tags/ubuntu/">ubuntu</a>
  
  <a class="badge badge-light" href="/tags/virtualbox/">virtualbox</a>
  
</div>




    
    

    

    


  </div>
</article>

<div class="container">
  <footer class="site-footer">
  

  <p class="powered-by">
    No&euml;l Boul&egrave;ne &copy; 2021. This blog is strictly personnal and opinions expressed here are only mine and doesn&#39;t reflect those of my past, current or futur employers. No warranty whatsoever is made that any of the posts are accurate. There is absolutely no assurance (apart from author&acute;s professional integrity) that any statement contained in a post is true, correct or precise. &middot; 

    Powered by the
    <a href="https://sourcethemes.com/academic/" target="_blank" rel="noopener">Academic theme</a> for
    <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a>.

    
    <span class="float-right" aria-hidden="true">
      <a href="#" id="back_to_top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

</div>


<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

    

    
    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha512-+NqPlbbtM1QqiK8ZAo4Yrj2c4lNQoGv8P79DPtKzj++l5jnN39rHA/xsqn8zE9l0uSoxaCdrOgFs6yjyfbBxSg==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.3/imagesloaded.pkgd.min.js" integrity="sha512-umsR78NN0D23AzgoZ11K7raBD+R6hqKojyBZs1w8WvYlsI+QuKRGBx3LFCwhatzBunCjDuJpDHwxD13sLMbpRA==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha256-VsEqElsCHSGmnmHXGQzvoWjWwoznFSZc6hs7ARLRacQ=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.2.5/jquery.fancybox.min.js" integrity="sha256-X5PoE3KU5l+JcX+w09p/wHl9AzK333C4hJ2I9S5mD4M=" crossorigin="anonymous"></script>

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>
        
      

      
      
    

    <script src="/js/hugo-academic.js"></script>
    

    
    

    
    
    

    
    
    <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script>
      const search_index_filename = "/index.json";
      const i18n = {
        'placeholder': "Search...",
        'results': "Search Results",
        'no_results': "No results found"
      };
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    <script src="/js/search.js"></script>
    

    
    

  </body>
</html>

